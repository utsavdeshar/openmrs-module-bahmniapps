name: Build and Publish

on:
  push:
    branches:
      - master
      - 'release-*'
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:

jobs:
  build-publish-docker:
    name: Build & Publish Docker Image
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: bahmni-web
      HELM_CHART_PATH: package/helm/

    steps:
      # ───────────────────────────── CHECKOUT ─────────────────────────────
      - uses: actions/checkout@v4

      # ───────────────────── VERSION USING COMMIT HASH ────────────────────
      - name: Set Docker Tag from Commit
        run: echo "ARTIFACT_VERSION=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # ───────────────────── NODE + RUBY SETUP ────────────────────────────
      - uses: actions/setup-node@v3
        with:
          node-version: 14.x

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.1

      - run: npm install -g bower grunt-cli yarn
      - run: gem install compass

      # ───────────────────── FRONTEND BUILD ───────────────────────────────
      - name: Micro-Frontends | Install Dependencies
        working-directory: micro-frontends
        run: yarn install --frozen-lock-file

      - name: Micro-Frontends | Build
        working-directory: micro-frontends
        run: yarn build

      - name: Package UI
        run: cd ui && yarn cache clean && /bin/bash ./scripts/package.sh

      # ───────────────────── BUILDX SETUP ────────────────────────────────
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      # ───────────────────── DOCKER HUB LOGIN ─────────────────────────────
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      # ───────────────────── MULTI-ARCH BUILD & PUSH ───────────────────────
      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: package/docker/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.ARTIFACT_VERSION }}
            ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
